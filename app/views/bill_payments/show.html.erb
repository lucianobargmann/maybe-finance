<%= turbo_frame_tag "modal" do %>
  <%= render DS::Dialog.new do |dialog| %>
    <% dialog.with_header(title: @bill_payment.recurring_bill.name) %>
    <% dialog.with_body do %>
      <div class="space-y-6">
        <div class="bg-surface-inset rounded-lg p-4">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <p class="text-secondary"><%= t(".due_date") %></p>
              <p class="font-medium text-primary"><%= l(@bill_payment.due_date, format: :long) %></p>
            </div>
            <div>
              <p class="text-secondary"><%= t(".expected_amount") %></p>
              <p class="font-medium font-mono text-primary"><%= format_money(@bill_payment.expected_amount_money) %></p>
            </div>
            <div>
              <p class="text-secondary"><%= t(".status") %></p>
              <p class="font-medium">
                <% status_color = case @bill_payment.status
                  when "paid" then "text-success"
                  when "overdue" then "text-destructive"
                  when "skipped" then "text-secondary"
                  else "text-warning"
                end %>
                <span class="<%= status_color %>"><%= t(".statuses.#{@bill_payment.status}") %></span>
              </p>
            </div>
            <% if @bill_payment.paid? %>
              <div>
                <p class="text-secondary"><%= t(".paid_date") %></p>
                <p class="font-medium text-primary"><%= @bill_payment.paid_date ? l(@bill_payment.paid_date, format: :long) : "-" %></p>
              </div>
              <div>
                <p class="text-secondary"><%= t(".actual_amount") %></p>
                <p class="font-medium font-mono text-primary"><%= format_money(@bill_payment.actual_amount_money) %></p>
              </div>
            <% end %>
          </div>
        </div>

        <%# Show matched transactions if any %>
        <% if @bill_payment.matched_transactions.any? %>
          <div class="border-t border-secondary pt-4">
            <h3 class="font-medium text-primary mb-2"><%= t(".matched_transactions") %></h3>
            <div class="space-y-2">
              <% @bill_payment.matched_transactions.each do |transaction| %>
                <div class="flex items-center justify-between bg-surface-inset rounded-lg p-3">
                  <div>
                    <p class="font-medium text-primary"><%= transaction.entry.name %></p>
                    <p class="text-sm text-secondary">
                      <%= l(transaction.entry.date, format: :short) %>
                      <% if transaction.merchant %>
                        - <%= transaction.merchant.name %>
                      <% end %>
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-primary"><%= format_money(transaction.entry.amount) %></span>
                    <%= render DS::Button.new(
                      text: t(".remove"),
                      variant: "outline",
                      size: "sm",
                      href: unmatch_bill_payment_path(@bill_payment, transaction_id: transaction.id),
                      method: :post,
                      frame: "modal"
                    ) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Show candidates to add more transactions %>
        <% if @match_candidates.any? %>
          <div class="border-t border-secondary pt-4">
            <h3 class="font-medium text-primary mb-2"><%= t(".suggested_matches") %></h3>
            <div class="space-y-2">
              <% @match_candidates.each do |transaction| %>
                <div class="flex items-center justify-between bg-surface-inset rounded-lg p-3">
                  <div>
                    <p class="font-medium text-primary"><%= transaction.entry.name %></p>
                    <p class="text-sm text-secondary">
                      <%= l(transaction.entry.date, format: :short) %>
                      <% if transaction.merchant %>
                        - <%= transaction.merchant.name %>
                      <% end %>
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-primary"><%= format_money(transaction.entry.amount) %></span>
                    <%= render DS::Button.new(
                      text: t(".add"),
                      variant: "primary",
                      size: "sm",
                      href: match_bill_payment_path(@bill_payment, transaction_id: transaction.id),
                      method: :post,
                      frame: "modal"
                    ) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Search for transactions %>
        <div class="border-t border-secondary pt-4">
          <h3 class="font-medium text-primary mb-3"><%= t(".search_transactions") %></h3>
          <%= form_with url: bill_payment_path(@bill_payment), method: :get, data: { turbo_frame: "modal" }, class: "space-y-3" do |f| %>
            <div>
              <%= f.text_field :search,
                  value: params[:search],
                  placeholder: t(".search_placeholder"),
                  class: "w-full px-3 py-2 bg-surface-inset border border-primary rounded-lg text-primary placeholder-secondary text-sm" %>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-secondary mb-1"><%= t(".start_date") %></label>
                <%= f.date_field :start_date,
                    value: params[:start_date] || (@bill_payment.due_date - 30.days).to_s,
                    class: "w-full px-3 py-2 bg-surface-inset border border-primary rounded-lg text-primary text-sm" %>
              </div>
              <div>
                <label class="block text-xs text-secondary mb-1"><%= t(".end_date") %></label>
                <%= f.date_field :end_date,
                    value: params[:end_date] || (@bill_payment.due_date + 7.days).to_s,
                    class: "w-full px-3 py-2 bg-surface-inset border border-primary rounded-lg text-primary text-sm" %>
              </div>
            </div>
            <%= f.submit t(".search_button"), class: "w-full px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium cursor-pointer hover:bg-primary/90" %>
          <% end %>
        </div>

        <% if @searching && @search_results %>
          <div class="space-y-2">
            <% if @search_results.any? %>
              <% @search_results.each do |transaction| %>
                <div class="flex items-center justify-between bg-surface-inset rounded-lg p-3">
                  <div>
                    <p class="font-medium text-primary"><%= transaction.entry.name %></p>
                    <p class="text-sm text-secondary">
                      <%= l(transaction.entry.date, format: :short) %>
                      <% if transaction.merchant %>
                        - <%= transaction.merchant.name %>
                      <% end %>
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-primary"><%= format_money(transaction.entry.amount) %></span>
                    <%= render DS::Button.new(
                      text: t(".add"),
                      variant: "primary",
                      size: "sm",
                      href: match_bill_payment_path(@bill_payment, transaction_id: transaction.id),
                      method: :post,
                      frame: "modal"
                    ) %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <p class="text-secondary text-sm text-center py-2"><%= t(".no_results") %></p>
            <% end %>
          </div>
        <% end %>

        <div class="flex gap-2 pt-4 border-t border-secondary">
          <% unless @bill_payment.paid? || @bill_payment.skipped? %>
            <%= render DS::Button.new(
              text: t(".skip_month"),
              variant: "outline",
              href: skip_bill_payment_path(@bill_payment),
              method: :post,
              frame: "_top"
            ) %>
          <% end %>
          <%= render DS::Button.new(
            text: t(".close"),
            variant: "ghost",
            type: "button",
            data: { action: "click->dialog#close" }
          ) %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
